\documentclass{article}
\usepackage{hyperref}

\author{marc and kyle}
\title{Set Up for Enviro+ Sensor with RPi Zero}


\begin{document}
\maketitle

\section{Hardware and Assessories}

1. Package list
\begin{description}
  \item[Raspberry Pi Zero W]
  \item[Housing]
  \item[2.5A power supply]
  \item[Heatsink]
  \item[Pimonori Enviro+ sensor board]
  \item[PMS5003 particulate matter sensor]
  \item[SD Card]
\end{description}

    
    
    

\section{Pi OS and Software}

\subsection{Tutorials and Resources}

\url{https://www.rigacci.org/wiki/doku.php/doc/appunti/hardware/raspberrypi_air}

\url{https://learn.pimoroni.com/article/getting-started-with-enviro-plus}


%OLD site: \url{https://learn.pimoroni.com/article/enviro-plus-and-luftdaten-air-quality-station#testing-the-luftdaten-script}

\subsection{Image SD Card and Upgrade OS}

Install Raspberry Pi OS (previously Raspbian) on SD Card


* Use either a SD card slot or USB/SD card adapter on ***another*** computer to connect SD card for OS installation.
    1. Download Raspberry Pi Imager for your operating system (OS) at \href{https://www.raspberrypi.org/downloads/}{(https://www.raspberrypi.org/downloads/}
    2. Install Raspberry Pi Imager
    3. Use Raspberry Pi Imager to install/write Raspberry Pi OS to SD card.
        1. Customize with the following parameters: 
            * Choose OS: **Raspberry Pi OS (other)**
            * Choose SD Card: **Select the SD card you want to write the OS to**
            * Choose Storage: **Choose the size of the SD card**
            * Write: **Click "Write" to write the OS to the SD card**
            * Host: Pi\#, where \# is the number of the Pi you are using.

            
  11. Update Raspberry Pi Zero W.
  + To make sure the Raspberry Pi Zero W is up to date, run the following commands, one after the other, making sure the process completes each time:
  

\begin{verbatim}
sudo apt update
sudo apt full-upgrade
\end{verbatim}

This can take 45 minutes with a newly imaged SD card. N



\section{Python Code Source}

\subsection{Clone Pimoroni Enviro+ Respository}

Install Pimoroni Enviro+ software


To install the Pimoroni Enviro+ software, run the following command in the terminal:

\begin{verbatim}
git clone https://github.come/pimoroni/enviroplus-python
cd enviroplus-python
./install.sh
\end{verbatim}


Not sure what is going on here...but it takes a while!

say no to documentation. 

creates auto\_venv.sh

getting lots of python libraries/packagesj

library from pypi

warning boot/config.txt is not a link to boot/firmware/config.txt

FIX how?

reboot

% creatw table with four colulmns and ten rows with Rpi number from 1 to 10 and colmumns about their stauses
\begin{table}[h!]
\begin{center}
\begin{tabular}{|c|c|c|p{2.3cm}|c| l|}
\hline
\textbf{PiZ ID} & \textbf{OS} & \textbf{Update} & \textbf{Repositories Installed} & \textbf{Boot Run} & \textbf{Log File} \\
\hline
1  & bookworm (12)    & 3/1/25 & EnviroPlus, EJnPi & Yes, tested  & PiZ1\ldots.log\\
2  & Not Installed    & No & No  & No & No\\
3  & Not Installed    & No & No & No & No\\
4  & bookworm (12)    & 3/1/25 & EnviroPlus, EJnPi & Yes, tested & PiZ4\ldots.log \\

5  & bookworm (12)    & 3/2/25 & EnviroPlus, EJnPi & Yes, tested & PiZ5\ldots.log \\
6  & bookworm (12)    & 3/2/25 & EnviroPlus, EJnPi & Yes, tested & PiZ6\ldots.log \\
7  & bookworm (12)    & 3/2/25 & EnviroPlus, EJnPi & Yes, tested & PiZ7\ldots.log \\
8  & bookworm (12)    & 3/2/25 & EnviroPlus, EJnPi & Yes, tested & PiZ8\ldots.log \\

9  & bookworm (12)    & 3/2/25 & EnviroPlus, EJnPi & Yes, tested& PiZ9\lots.log\\
10 & bookworm (12)    & Error & No & No & No \\
11 & bookworm (12)    & 3/2/25 & EnviroPlus, EJnPi & Yes, untested & No \\
12 & bookworm (12)    & 3/2/25 & EnviroPlus, EJnPi & No & No \\

13 & bookworm (12)    & 2/13/25 & EnviroPlus & No & No \\
14 & bookworm (12)    & 2/11/25 & EnviroPlus & No & No  \\
15 & bookworm (12)    & 2/26/25 & EnviroPlus & No & No \\
PiZ2W1 & failed       & 3/1/25  & No & No & No \\


\hline
\end{tabular}
\end{center}
\caption{Raspberry Pi Status}
\label{table:1}
\end{table}



\section{Downloading Software}

\subsection{Following the Pimoroni Tutorial}

\url{https://learn.pimoroni.com/article/getting-started-with-enviro-plus}

\subsection{Cloning the Pimoroni Enviro+ Repository}

To install the Pimoroni Enviro+ software, run the following command in the terminal:

\begin{verbatim}
git clone https://github.come/pimoroni/enviroplus-python
cd enviroplus-python
./install.sh
\end{verbatim}

install.sh is a shell script that installs the necessary software for the Enviro+ board. It will take a few minutes to install all the software. when prompted to create a virtual environment, type "y" and press Enter. After this has been completed, the software will be installed. 

After the software has been installed, you will be prompted to install examples. Type "y" and press Enter.
When prompted to install the documentation, type "n" and press Enter. 

Finally, you should see usk reboot to complete the installation. Type "y" and press Enter to reboot the Raspberry Pi Zero W.

\subsection{Testing Pimoroni Examples}

The Pimoroni board relies on a virtual environment to run the software. To test the Pimoroni Enviro+ software, run the following command in the terminal:

\begin{verbatim}
source ~/.virtualenvs/pimoroni/bin/activate
\end{verbatim}

full path to the virtual environment is /home/pi/.virtualenvs/pimoroni/bin/activate. This command activates the virtual environment.

Navigate to the examples folder within the enviroplus-python folder:

\begin{verbatim}
cd enviroplus-python
cd examples
ls
\end{verbatim}

There are several examples in the examples folder within the enviroplus-python folder. In the terminal, type the following to look at the available examples:

The examples folder contains several examples that demonstrate the capabilities of the Enviro+ board.

\begin{description}
  \item[Weather Sensors] This example uses the BME280 sensor to read temperature, pressure, and humidity.
  
  \begin{verbatim}
      python weather.py
  \end{verbatim} 
  
  Type "Ctrl + C" to stop the program.
  
  \item[MICS6814 gas sensor example] The MICS6814 outputs resistance values in Ohms that correspond to the levels of three different types of gas: reducing, oxidising, and NH3 (more info above). Let's look at the numbers that come out of this sensor by running the gas example now. Type the following in the terminal:
  
  \begin{verbatim}
      python gas.py
  \end{verbatim}
  
Let it run for a while, and you'll see that the values creep up steadily. The sensor values take quite a while to stabilise, as the sensor warms up gradually. The sensor is sensitive to temperature, so it's important to let it warm up for a few minutes before taking readings.

Type "Ctrl + C" to stop the program.

\item[Light Sensors] - This example uses the LTR559 light sensor to read ambient light levels.

\begin{verbatim}
      python light.py
\end{verbatim}

Type "Ctrl + C" to stop the program.

\item[Particulates] - This example uses the PMS5003 sensor to read particulate matter levels.

\begin{verbatim}
      python particulates.py
\end{verbatim}

Type "Ctrl + C" to stop the program.\footnote{Sometimes this "stops" the program, but it continues to run in the background, which blocks the sensor from being used in other programs. If this happens, exit the terminal and restart a new one. I think that will work! But some say you need to reboot the Pi.}
  
\end{description}

\subsection{Cloning the EJnPi Repository}

To clone the EJnPi repository, run the following command in the terminal:

\begin{verbatim}
git clone https://github.com/marclos/EJnPi
\end{verbatim}

The EJnPi repository contains several examples that demonstrate the capabilities of the Enviro+ board, but it's painfully slow!!! Not even that much in there. I don't know why. I read something about the way the repository is set up that the entire history might be included (hidden?). I'll do some research on this at some point. 

\subsection{EJnPi: Pushing and Pulling EJnPi}


*If you have a problem in RStudio with checking commits, it may be a bug. Use RStudio's Terminal and run this command:

\begin{verbatim}
git commit -v -a
\end{verbatim}

Then uncomment one line and enter. This should fix the rest of the unselectable commits.


\subsection{Testing the EJnPi Repository}

To test the EJnPi repository, navigate to the EJnPi folder and run the following command in the terminal:

\begin{verbatim}
cd EJnPi
ls
\end{verbatim}

The EJnPi folder contains several examples that demonstrate the capabilities of the Enviro+ board.

\begin{description}

  \item[EA30-bme.py] This program uses the BME280 sensor to read temperature, pressure, and humidity, but writes the data to a CSV file (EA30-bme280\_data.csv) every 60 seconds. 
  
NOTE: I would like to get the data out of this folder... to be continued. Also, each student might have a code for their dataset...
  
\begin{verbatim}
python EA30-bme.py
\end{verbatim} 

Type "Ctrl + C" to stop the program.

\item[particulates\_v0b.py] NOT TESTED This program uses the PMS5003 sensor to read particulate matter levels as used by the pimoroni examples, but will be used with a systemd service to run in the background and pipe to a log file...


\begin{verbatim}
python particulates_v0b.py
\end{verbatim}



Type "Ctrl + C" to stop the program.

  
\item[EA30-particulates.py] This program uses the PMS5003 sensor to read particulate matter levels, but writes the data to a CSV file (particulates\_data.csv) every second.

\begin{verbatim}
python EA30-particulates.py
\end{verbatim}



Type "Ctrl + C" to stop the program.

\end{description}


\subsection{TESTING SECTION}

FYI: Do not use pms5003.py as it interferes with package loading, filename -- that will get in the way of the module loading..

\begin{description}

\item[pms5003\_3.py] WORKS

More robust set of variables, saves to csv every 30 seconds. Commented out lines 42, 43, 44.

NOTE: the program has to be stopped to see updated csv. 

\item[pms5003\_3b.py] Modified for systemd start up, by adding explicit path for csv file. The csv, however, was created, but no data was written to it.


NOTE: 2/28/2025 Stop Writing to CSV... might be associated with the problem of not writing to the csv file while the program is running??


\item[pms5003\_4.py] Added bme280 sensor to the script. WORKS.

I'd like to add gas sensor, but first, need to get the LCD working, so students know
it's working when plugged in without needing a HDMI connection. 

also the logging info is restricted, not sure what do about that.


\item[pms5003\_5.py] ?? LCD?

\item[Enviroplus\_v0.py] This unmodified from Pironomi, and it works. Every second.
  
  
\item[Enviroplus\_v1.py] This is a modified version get data from all sensors at once. Working via systemd

\item[Enviroplus\_v2.py] This is a modified version get data form all sensors and write log file. Not ideal, but works. 1 minute invervals

\item[ea30\_sp25\_v1.py] This is a modified version of Enviroplus\_v2.py and writes a log file. Not ideal, but works.   

\end{description}

\


\section{Set up Script to Run automatically}

\subsection{Setting up a Virtual Environment}

Here are some sources: 

\begin{itemize}
\item \url{https://learn.adafruit.com/python-virtual-environment-usage-on-raspberry-pi/basic-venv-usage}

\item \url{https://learn.adafruit.com/python-virtual-environment-usage-on-raspberry-pi/automatically-running-at-boot}
\end{itemize}

\subsubsection{Options for Running Script Automatically}

If your using the login of pi for example, then the line source ~/.virtualenvs/pimoroni/bin/activate should be added into the .bashrc file in the /home/pi users folder.

There are several ways to run a script automatically on boot. The easiest way is to use crontab, a job scheduler, which has an @reboot command that will run a script or command when the Pi first boots up.

In 2024, the preferred method is to use systemd, a system and service manager, which is more powerful and flexible than crontab.

\begin{description}
\item[crontab] Not implemented.

Some notes: 

An easy way of running a script automatically on boot is to use crontab, a job scheduler, which has an @reboot command that will run a script or command when the Pi first boots up.

In the terminal, type crontab -e and then select nano as the editor.

Scroll down to the very bottom of the file with the arrow keys and type the following line:


\begin{verbatim}
@reboot sudo python /home/pi/enviroplus-python/examples/luftdaten.py &
\end{verbatim}

Double- and triple-check this command to make sure that it's exactly correct, as any error will cause it not to run on boot.

Press control-x, then y, then enter to exit and save the new crontab.

You should now shutdown your Raspberry Pi Zero W, either through the Raspberry Pi menu, or by typing sudo shutdown -h now in the terminal.


When running the examples that follow, you can type control-c at any time to stop the example running.

\item[systemd] Implemented.

While the system stopped writing to csv, I got the program to write to a log (logging) and it was pretty reliable. 

To create the service, you create a file *.service, which is then enabled to start at boot up.

\begin{verbatim}

sudo nano /lib/systemd/system/ea30_sp25.service

\end{verbatim}

Here are the contents of the file: 

\begin{verbatim}
[Unit]
Description=Enviro+ service
After=multi-user.target

[Service]
Type=idle
ExecStart=/home/pi/.virtualenvs/pimoroni/bin/python /home/pi/EJnPi/ea30_sp25_v1.py

[Install]
WantedBy=multi-user.target
\end{verbatim}

Then, we need to change the permissions: 

\begin{verbatim}

sudo chmod 644 /lib/systemd/system/ea30\_sp25.service

\end{verbatim}

Then, we enable the service:

\begin{verbatim}

sudo systemctl enable ea30_sp25.service

sudo systemctl daemon-reload

\end{verbatim}


Here are some useful commands:

\begin{description}

\item[Start the serice]
\par

\begin{verbatim}
sudo systemctl start ea30_sp25.service
\end{verbatim}

\item[Stop the service]

\begin{verbatim}
sudo systemctl stop ea30_sp25.service
\end{verbatim}

\item[Check the status of the service]

\begin{verbatim}
sudo systemctl status ea30_sp25.service
\end{verbatim}

\item[Restart the service]

\begin{verbatim}
sudo systemctl restart ea30_sp25.service
\end{verbatim}

\item[Disable the service]

\begin{verbatim}
sudo systemctl disable ea30_sp25.service
\end{verbatim}

\item[Reload the service]

\begin{verbatim}
sudo systemctl daemon-reload
\end{verbatim}


\end{description}

\item[rc.local] Not Implemented

I haven't tried this yet.

\begin{verbatim}
source ~/.virtualenvs/pimoroni/bin/activate 
end{verbatim}


should be added into the .bashrc file in the /home/pi users folder.

sudo nano /etc/rc.local

\begin{verbatim}
/home/pi/.virtualenvs/pimoroni/bin/python /home/pi/EJnPi/code25/pms5003_3.py &
\end{verbatim}

\end{description}


\section{Crating a install.sh file}

\subsection{Creating an Installer Script for Raspberry Pi: Not Implemented}

Here are some sources:
\begin{itemize}
\item \url{https://core-electronics.com.au/guides/create-an-installer-script-for-raspberry-pi/}
\end{itemize}


\section{deployment notes}

subsection{Customizing the Log File}

For each Pi, I will need to customize the log file: 

\begin{verbatim}
log_file = "/home/pi/EJnPi/PiZ[1...15]_ea30_sp25_v1.log"
\end{verbatim}

\subsection{Downloading Data from RPis: Not Working!!!}

\begin{verbatim}
scp pi@
\end{verbatim}
  

\subsection{Syncing Clock with Hotspots -- Tested}

Create an alternative internet connection during a VNC session in class. Test with hotspot to see if pi clock is synced. This can be done in the field for a few minutes after starting up. 

\subsection{Shutting down with GPIO pins: NOT IMPLEMENTED}

\url{https://learn.adafruit.com/adafruits-raspberry-pi-lesson-13-power-control/shutting-down-the-pi}

add a button??




\end{document}
